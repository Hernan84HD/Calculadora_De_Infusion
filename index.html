<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de infusión - Internista Veterinario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body {
            background-color: #f1f5f9;
            font-family: 'Inter', sans-serif;
            color: #0f172a;
        }

        .solid-card {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .input-field {
            background: #ffffff;
            border: 2px solid #cbd5e1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-weight: 700;
            color: #1e293b;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #16a34a; 
            background: #f0fdf4; 
        }

        label {
            color: #475569;
            font-weight: 800;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.35rem;
            display: block;
        }

        .drug-card {
            border-left: 6px solid #16a34a; 
        }

        .result-badge {
            background: #dcfce7; 
            color: #166534; 
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 800;
            display: inline-block;
            border: 1px solid #bbf7d0; 
        }

        .modern-table th {
            background-color: #1e293b;
            color: #ffffff;
            padding: 1rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modern-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .quad-pulse {
            transition: background-color 0.1s ease, transform 0.1s ease;
        }
        
        .pulse-active-bg {
            background-color: rgba(255, 255, 255, 0.4) !important;
            transform: scale(1.02);
        }

        .metronomo-on {
            border: 2px solid #ffffff !important;
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="p-4 pb-24">

    <div class="max-w-md mx-auto">
        <!-- HEADER -->
        <header class="flex items-center gap-4 mb-8">
            <div class="bg-slate-900 p-3 rounded-2xl shadow-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-800 tracking-tighter text-slate-900 uppercase">Calculadora de <span class="text-green-600">infusión</span></h1>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Internista Veterinario</p>
            </div>
        </header>

        <!-- PARÁMETROS BASE -->
        <section class="solid-card p-6 mb-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label>Peso (kg)</label>
                    <input type="number" id="peso" placeholder="0.0" step="0.1" oninput="calcularTodo()" class="input-field w-full">
                </div>
                <div>
                    <label>Sachet (ml)</label>
                    <input type="number" id="volSachet" placeholder="500" oninput="calcularTodo()" class="input-field w-full">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label>Ritmo (ml/kg/h)</label>
                    <input type="number" id="ritmoFluidos" placeholder="5" step="0.1" oninput="calcularTodo()" class="input-field w-full">
                </div>
                <div>
                    <label>Factor Goteo</label>
                    <select id="factorGoteo" onchange="calcularTodo()" class="input-field w-full appearance-none">
                        <option value="20">Macro (20 gtt/ml)</option>
                        <option value="60">Micro (60 gtt/ml)</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- MEDICAMENTOS -->
        <div id="listaMedicamentos" class="space-y-4"></div>

        <div class="mt-8 mb-10 text-center">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Configurar Mezcla</p>
            <div class="grid grid-cols-2 gap-4 px-2">
                <button onclick="agregarMedicamento()" 
                        class="p-4 rounded-2xl border-2 border-slate-300 text-slate-600 font-bold hover:bg-slate-100 transition-colors flex items-center justify-center gap-2">
                    <span class="text-xl">+</span> MANUAL
                </button>
                <button onclick="abrirModalFrecuentes()" 
                        class="p-4 rounded-2xl bg-green-600 text-white font-bold shadow-lg shadow-green-200 active:bg-green-700 transition-colors flex items-center justify-center gap-2">
                    <span>⭐</span> FAVORITOS
                </button>
            </div>
        </div>

        <!-- MONITOR DE RESULTADOS -->
        <div id="seccionResultados" class="hidden">
            <div class="bg-slate-900 rounded-[2.5rem] p-0 mb-6 text-white shadow-2xl border-b-8 border-green-600 overflow-hidden">
                <div class="grid grid-cols-2">
                    <div class="text-center p-8 border-r border-b border-slate-800">
                        <p class="text-[12px] font-black text-slate-400 uppercase mb-2 tracking-wider">Velocidad</p>
                        <p class="text-3xl font-800 text-white" id="resMlHora">--</p>
                    </div>

                    <div id="quadGoteo" onclick="toggleMetronomo()" class="text-center p-8 border-b border-slate-800 cursor-pointer quad-pulse transition-all active:opacity-80 flex flex-col items-center justify-center">
                        <p class="text-[12px] font-black text-slate-400 uppercase mb-2 tracking-wider">Goteo Manual</p>
                        <p class="text-3xl font-800 text-white" id="resGoteo">--</p>
                        <div id="statusIcon" class="mt-3 text-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                    </div>

                    <div class="text-center p-8 border-r border-slate-800">
                        <p class="text-[12px] font-black text-slate-400 uppercase mb-2 tracking-wider">Duración</p>
                        <p class="text-3xl font-800 text-emerald-400" id="resDuracion">--</p>
                    </div>

                    <div class="text-center p-8">
                        <p class="text-[12px] font-black text-slate-400 uppercase mb-2 tracking-wider">Retirar Suero</p>
                        <p class="text-3xl font-800 text-rose-400" id="totalRetirar">--</p>
                    </div>
                </div>
            </div>

            <!-- TABLA DE MEZCLA -->
            <div class="solid-card overflow-hidden mb-10 text-center">
                <table class="modern-table w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="text-left w-1/3">Fármaco</th>
                            <th class="text-center w-1/3">Masa Total (mg)</th>
                            <th class="text-right w-1/3">Vol. Total (ml)</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla" class="font-bold text-slate-700 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL VADEMÉCUM -->
    <div id="modalFrecuentes" class="hidden fixed inset-0 bg-slate-900/80 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-900 text-slate-900 uppercase">Favoritos</h3>
                <button onclick="cerrarModalFrecuentes()" class="text-slate-400 text-3xl">&times;</button>
            </div>
            <div id="opcionesFrecuentes" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        const vademecum = [
            { nombre: "Ampicilina", conc: 100, bolo: 20, cri: 20 },
            { nombre: "Atropina", conc: 1, bolo: 0.04, cri: 0.04 },
            { nombre: "Butorfanol", conc: 10, bolo: 0.2, cri: 0.2 },
            { nombre: "Cefalexina", conc: 100, bolo: 20, cri: 20 },
            { nombre: "Ceftriaxona", conc: 100, bolo: 25, cri: 25 },
            { nombre: "Dexametasona", conc: 4, bolo: 1, cri: 1 },
            { nombre: "Diazepam", conc: 5, bolo: 0.5, cri: 0.5 },
            { nombre: "Dipirona", conc: 500, bolo: 25, cri: 25 },
            { nombre: "Enrofloxacina", conc: 10, bolo: 5, cri: 5 },
            { nombre: "Furosemida", conc: 10, bolo: 2, cri: 2 },
            { nombre: "Gentamicina", conc: 40, bolo: 6, cri: 6 },
            { nombre: "Metoclopramida", conc: 5, bolo: 1, cri: 1 },
            { nombre: "Ondansetrón", conc: 2, bolo: 1, cri: 1 },
            { nombre: "Ranitidina", conc: 25, bolo: 2, cri: 2 },
            { nombre: "Tramadol", conc: 50, bolo: 2, cri: 2 }
        ];

        let drugCount = 0;
        let metroInterval = null;
        let currentSegGtt = 0;
        let audioCtx = null;

        const iconPlay = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>`;
        const iconStop = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z" /></svg>`;

        function agregarMedicamento(preset = null) {
            drugCount++;
            const container = document.getElementById('listaMedicamentos');
            const div = document.createElement('div');
            div.className = 'solid-card drug-card p-6 relative animate-pop';
            div.id = `drug-${drugCount}`;
            
            const d = preset || { nombre: "", conc: "", bolo: "", cri: "" };

            div.innerHTML = `
                <button onclick="eliminarMedicamento(${drugCount})" class="absolute top-4 right-4 text-slate-400 font-bold uppercase text-[10px]">Quitar ×</button>
                <div class="mb-4">
                    <label>Fármaco</label>
                    <input type="text" value="${d.nombre}" class="input-field w-full text-green-700 drug-name" oninput="calcularTodo()">
                </div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div><label>Conc (mg/ml)</label><input type="number" value="${d.conc}" class="conc input-field w-full text-center" step="0.001" oninput="calcularTodo()"></div>
                    <div><label>Bolo (mg/kg)</label><input type="number" value="${d.bolo}" class="bolo input-field w-full text-center" step="0.001" oninput="calcularTodo()"></div>
                    <div><label>CRI (mg/kg/h)</label><input type="number" value="${d.cri}" class="cri input-field w-full text-center" step="0.001" oninput="calcularTodo()"></div>
                </div>
                <div class="result-badge uppercase text-xs">Bolo Inicial: <span class="res-bolo-val">0.00</span> ml</div>
            `;
            container.appendChild(div);
            if (preset) cerrarModalFrecuentes();
            calcularTodo();
        }

        function eliminarMedicamento(id) {
            document.getElementById(`drug-${id}`).remove();
            calcularTodo();
        }

        function abrirModalFrecuentes() {
            const modal = document.getElementById('modalFrecuentes');
            const lista = document.getElementById('opcionesFrecuentes');
            lista.innerHTML = "";
            vademecum.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(f => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-green-500 font-bold flex justify-between items-center transition-all";
                btn.innerHTML = `<span>${f.nombre}</span> <span class="text-slate-400 text-xs">${f.conc} mg/ml</span>`;
                btn.onclick = () => agregarMedicamento(f);
                lista.appendChild(btn);
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function cerrarModalFrecuentes() {
            document.getElementById('modalFrecuentes').classList.add('hidden');
        }

        async function playBeep() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime); 
                
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);

                const quad = document.getElementById('quadGoteo');
                quad.classList.add('pulse-active-bg');
                setTimeout(() => quad.classList.remove('pulse-active-bg'), 100);
            } catch (e) { console.error(e); }
        }

        async function toggleMetronomo() {
            const quad = document.getElementById('quadGoteo');
            const iconContainer = document.getElementById('statusIcon');
            
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();

            if (metroInterval) {
                clearInterval(metroInterval);
                metroInterval = null;
                iconContainer.innerHTML = iconPlay;
                iconContainer.classList.remove('text-white');
                iconContainer.classList.add('text-slate-500');
                quad.classList.remove('metronomo-on');
            } else {
                if (currentSegGtt > 0) {
                    playBeep(); 
                    metroInterval = setInterval(playBeep, currentSegGtt * 1000);
                    iconContainer.innerHTML = iconStop;
                    iconContainer.classList.remove('text-slate-500');
                    iconContainer.classList.add('text-white');
                    quad.classList.add('metronomo-on');
                }
            }
        }

        function calcularTodo() {
            const peso = parseFloat(document.getElementById('peso').value);
            const volSachet = parseFloat(document.getElementById('volSachet').value);
            const ritmoFluidos = parseFloat(document.getElementById('ritmoFluidos').value);
            const factorGoteo = parseFloat(document.getElementById('factorGoteo').value);
            const seccion = document.getElementById('seccionResultados');
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            
            if (peso && volSachet && ritmoFluidos) {
                seccion.classList.remove('hidden');
                cuerpoTabla.innerHTML = "";
                let totalDrogasMl = 0;

                const mlHora = peso * ritmoFluidos;
                const gttMin = (mlHora * factorGoteo) / 60;
                const segGtt = gttMin > 0 ? (60 / gttMin) : 0;
                currentSegGtt = segGtt;

                if (metroInterval) {
                    clearInterval(metroInterval);
                    metroInterval = setInterval(playBeep, currentSegGtt * 1000);
                }

                const horas = volSachet / mlHora;

                document.getElementById('resMlHora').innerText = mlHora.toFixed(1) + " ml/h";
                document.getElementById('resGoteo').innerText = `${segGtt.toFixed(1)}s`;
                document.getElementById('resDuracion').innerText = Math.floor(horas) + "h " + Math.round((horas % 1) * 60) + "m";

                document.querySelectorAll('.drug-card').forEach(card => {
                    const nombre = card.querySelector('.drug-name').value || "Droga";
                    const conc = parseFloat(card.querySelector('.conc').value);
                    const bolo = parseFloat(card.querySelector('.bolo').value) || 0;
                    const cri = parseFloat(card.querySelector('.cri').value) || 0;

                    if (conc > 0) {
                        const bMl = (peso * bolo) / conc;
                        const mMl = (cri * volSachet) / (ritmoFluidos * conc);
                        const mgTotales = mMl * conc;
                        totalDrogasMl += mMl;
                        card.querySelector('.res-bolo-val').innerText = bMl.toFixed(2);
                        cuerpoTabla.innerHTML += `
                            <tr>
                                <td class="text-left text-green-700 font-bold">${nombre}</td>
                                <td class="text-center text-slate-500">${mgTotales.toFixed(1)}</td>
                                <td class="text-right text-green-600 font-900">${mMl.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                });
                document.getElementById('totalRetirar').innerText = totalDrogasMl.toFixed(2) + " ml";
            } else {
                seccion.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
